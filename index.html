<!DOCTYPE html>
<html>
  <head>
    <title>Connect 4</title>
    <style>
      header {
        text-align: center;
      }
      #info {
        text-align: center;
        border: 3px solid black;
        background-color: grey;
      }
      #existing {
        text-align: center;
        border: 3px solid black;
        background-color: grey;
      }
      #randomBox {
        text-align: center;
        border: 3px solid black;
        background-color: grey;
      }
      table {
        margin-left: auto;
        margin-right: auto;
        border-collapse: collapse; 
        width: 80%;
      }
      #error {
        color: red;
      }
      #error1 {
        color: red;
      }
      #name {
        color: blue;
        text-align: center;
      }
      #code{
        color: blue;
      }
      #gamepage{
        display: none;
      }
      #intro{
        text-align: center;
      }
      #color{
        text-align: center;
      }
      .grid-container {
        display: grid;
        grid-template-columns: auto auto auto auto auto auto auto;
        grid-template-rows: auto auto auto auto auto auto;
        background-color: rgb(33, 150, 243);
        padding: 10px;
        border: 1px solid black;
        width: 800px;
        margin: auto;
      }
      .grid-item {
        background: white;
        border: 1px solid black;
        border-radius: 50%;
        width: 100px;
        height: 100px;
        align-self: center;
        margin: auto;
        margin-bottom: 6px;
      }
      .grid-button {
        padding: 20px;
        width: 100px;
        height: 100px;
      }
      #turn{
        text-align: center;
      }
      .grid-button:hover {
        border-radius: 50%;
        background: radial-gradient(circle, transparent 1%, #47a7f5 1%) center/15000%;
        background-color: rgb(255, 0, 0);
      }
    </style>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  </head>
  <body>

    <header id="frontheader">
      <h1 id="Title">Connect 4</h1>
      <p id="welcome">We created a name for you:</p>
      <p id="error"></p>
      <input id="name" ></input>
      <p>You can edit your name.</p>
      <p id="error1"></p>
    </header>

    <table id="frontpage">
      <tr>
        <td id="info" rowspan="2">
          <p>To <b>start a new game</b>, give this code to your opponent:</p>
          <div id="code"></div>
          <p>Tell your opponent to visit this site and enter the code on the right.</p>
        </td>
        <td id="existing">
          <p>to <b>join an existing game</b>, enter someone's game code:</p>
          <input id="room"></input>
          <button id="start">Start</button>
        </td>
      </tr>
      <tr>
        <td id="randomBox">
          <p>
            to start a <b>random game</b>, click below:
          </p>
          <button id="random">Random</button>
        </td>
      </tr>
    </table>

    <div id="gamepage">
      <div id="intro">
        <span id="name2"></span>
        <span>you are playing Connect 4</span>
      </div>
      <div id="turn">whos turn is it</div>
      <div id="taketurn" class="grid-container">
        <div class="grid-button" id="0"></div>
        <div class="grid-button" id="1"></div>
        <div class="grid-button" id="2"></div>
        <div class="grid-button" id="3"></div>
        <div class="grid-button" id="4"></div>
        <div class="grid-button" id="5"></div>
        <div class="grid-button" id="6"></div>
      </div>
      <div id="gameboard" class="grid-container">
        <div class="grid-item" id="50"></div>
        <div class="grid-item" id="51"></div>
        <div class="grid-item" id="52"></div>
        <div class="grid-item" id="53"></div>
        <div class="grid-item" id="54"></div>
        <div class="grid-item" id="55"></div>
        <div class="grid-item" id="56"></div>
        <div class="grid-item" id="40"></div>
        <div class="grid-item" id="41"></div>
        <div class="grid-item" id="42"></div>
        <div class="grid-item" id="43"></div>
        <div class="grid-item" id="44"></div>
        <div class="grid-item" id="45"></div>
        <div class="grid-item" id="46"></div>
        <div class="grid-item" id="30"></div>
        <div class="grid-item" id="31"></div>
        <div class="grid-item" id="32"></div>
        <div class="grid-item" id="33"></div>
        <div class="grid-item" id="34"></div>
        <div class="grid-item" id="35"></div>
        <div class="grid-item" id="36"></div>
        <div class="grid-item" id="20"></div>
        <div class="grid-item" id="21"></div>
        <div class="grid-item" id="22"></div>
        <div class="grid-item" id="23"></div>
        <div class="grid-item" id="24"></div>
        <div class="grid-item" id="25"></div>
        <div class="grid-item" id="26"></div>
        <div class="grid-item" id="10"></div>
        <div class="grid-item" id="11"></div>
        <div class="grid-item" id="12"></div>
        <div class="grid-item" id="13"></div>
        <div class="grid-item" id="14"></div>
        <div class="grid-item" id="15"></div>
        <div class="grid-item" id="16"></div>
        <div class="grid-item" id="00"></div>
        <div class="grid-item" id="01"></div>
        <div class="grid-item" id="02"></div>
        <div class="grid-item" id="03"></div>
        <div class="grid-item" id="04"></div>
        <div class="grid-item" id="05"></div>
        <div class="grid-item" id="06"></div>
      </div>
      <div id="color">
        <span>Color theme:</span>
        <button id="normalColor">Normal</button>
        <button id="vibeColor">Vibe</button>
        <button id="rainbowColor">Rainbow</button>
      </div>
    </div>

    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function() {
        var socket = io();
        var cookieName;
        var backgroundColor = "rgb(33, 150, 243)";
        var placeColor;

        if(document.cookie
          .split(";")
          .filter(item => item.trim().startsWith("color=")).length &&
          document.cookie.replace(
            /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
            "$1"
          ) == "Vibe"
        ){
          backgroundColor = "rgb(199, 21, 133)";
          $(".grid-container").css("background", backgroundColor);
        }
        else if (document.cookie
          .split(";")
          .filter(item => item.trim().startsWith("color=")).length &&
          document.cookie.replace(
            /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
            "$1"
          ) == "Rainbow"
        ){
          backgroundColor = "rgb(238, 130, 238)";
          $(".grid-container").css("background", backgroundColor);

        } else {
          backgroundColor = "rgb(33, 150, 243)";
          $(".grid-container").css("background", backgroundColor);
        }


        if (
          document.cookie
            .split(";")
            .filter(item => item.trim().startsWith("name=")).length
        ) {
          cookieName = document.cookie.replace(
            /(?:(?:^|.*;\s*)name\s*\=\s*([^;]*).*$)|^.*$/,
            "$1"
          );
          
          $("#welcome").text("Welcome back");
          socket.emit("existing users", cookieName);
        } else {
          socket.emit("new users");
        }

        $("#normalColor").click(function () {
          document.cookie = "color=Normal";
          backgroundColor = "rgb(33, 150, 243)";
          $(".grid-container").css("background", backgroundColor);
          $(".grid-button").css("background", backgroundColor);

          if (placeColor == "rgb(13, 152, 186)" || placeColor == "rgb(130, 238, 238)") {
            $(".grid-button").hover(function () {
              $(this).css("background", "rgb(255, 0, 0)");
            }, function () {
              $(this).css("background", backgroundColor);
            });
            placeColor = "rgb(255, 0, 0)";

          } else if (placeColor == "rgb(255, 174, 66)" || placeColor == "rgb(238, 238, 130)") {
            $(".grid-button").hover(function () {
              $(this).css("background", "rgb(255, 255, 0)");
            }, function () {
              $(this).css("background", backgroundColor);
            });
            placeColor = "rgb(255, 255, 0)";
          }

          for (i = 0; i < 6; i++) {
            for (j = 0; j < 7; j++) {
              var color = window.getComputedStyle(document.getElementById(""+i+j), null).getPropertyValue("background-color");
              if (color == "rgb(13, 152, 186)" || color == "rgb(130, 238, 238)") {
                $("#" + i + j).css("background", "rgb(255, 0, 0)");
              } else if (color == "rgb(255, 174, 66)" || color == "rgb(238, 238, 130)") {
                $("#" + i + j).css("background", "rgb(255, 255, 0)");
              }
            }
          }

        });

        $("#vibeColor").click(function () {
          document.cookie = "color=Vibe";
          backgroundColor = "rgb(199, 21, 133)";
          $(".grid-container").css("background", backgroundColor);
          $(".grid-button").css("background", backgroundColor);

          if(placeColor == "rgb(255, 0, 0)" || placeColor == "rgb(130, 238, 238)"){
            $(".grid-button").hover(function () {
              $(this).css("background", "rgb(13, 152, 186)");
            }, function () {
              $(this).css("background", backgroundColor);
            });
            placeColor = "rgb(13, 152, 186)";

          } else if(placeColor == "rgb(255, 255, 0)" || placeColor == "rgb(238, 238, 130)"){
            $(".grid-button").hover(function () {
              $(this).css("background", "rgb(255, 174, 66)");
            }, function () {
              $(this).css("background", backgroundColor);
            });
            placeColor = "rgb(255, 174, 66)";
          }

          for (i = 0; i < 6; i++) {
            for (j = 0; j < 7; j++) {
              var color = window.getComputedStyle(document.getElementById(""+ i+j), null).getPropertyValue("background-color");
              if(color == "rgb(255, 0, 0)" || color == "rgb(130, 238, 238)"){
                $("#" + i + j).css("background", "rgb(13, 152, 186)");
              } else if (color == "rgb(255, 255, 0)" || color == "rgb(238, 238, 130)"){
                $("#" + i + j).css("background", "rgb(255, 174, 66)");
              }
            }
          }

        });

        $("#rainbowColor").click(function () {
          document.cookie = "color=Rainbow";
          backgroundColor = "rgb(238, 130, 238)";
          $(".grid-container").css("background", backgroundColor);
          $(".grid-button").css("background", backgroundColor);

          if (placeColor == "rgb(255, 0, 0)" || placeColor == "rgb(13, 152, 186)") {
            $(".grid-button").hover(function () {
              $(this).css("background", "rgb(130, 238, 238)");
            }, function () {
              $(this).css("background", backgroundColor);
            });
            placeColor = "rgb(130, 238, 238)";

          } else if (placeColor == "rgb(255, 255, 0)" || placeColor == "rgb(255, 174, 66)") {
            $(".grid-button").hover(function () {
              $(this).css("background", "rgb(238, 238, 130)");
            }, function () {
              $(this).css("background", backgroundColor);
            });
            placeColor = "rgb(238, 238, 130)";
          }

          for (i = 0; i < 6; i++) {
            for (j = 0; j < 7; j++) {
              var color = window.getComputedStyle(document.getElementById("" + i + j), null).getPropertyValue("background-color");
              if (color == "rgb(255, 0, 0)" || color == "rgb(13, 152, 186)") {
                $("#" + i + j).css("background", "rgb(130, 238, 238)");
              } else if (color == "rgb(255, 255, 0)" || color == "rgb(255, 174, 66)") {
                $("#" + i + j).css("background", "rgb(238, 238, 130)");
              }
            }
          }

        });

        //set lobby number
        $("#start").click(function() {
          if(cookieName != $("#name").val()){
            socket.emit("change username", { old: cookieName, new: $("#name").val() });
          }

          //code lobby
          socket.emit("code lobby", $("#room").val() );

        });

        $("#random").click(function () {
          if (cookieName != $("#name").val()) {
            socket.emit("change username", { old: cookieName, new: $("#name").val() });
          }
          //random lobby
          socket.emit("code lobby", -1);
        });


        $(".grid-button").click(function() {
          if($("#"+this.id).attr('disabled') == "disabled"){
            return false;
          }
          else{
            takeMyTurn(this.id);
          }
        });

        function takeMyTurn(number){
          var color = window.getComputedStyle(document.getElementById(number), null).getPropertyValue("background-color");
          if(color == "rgb(255, 0, 0)" || color == "rgb(13, 152, 186)" || color == "rgb(130, 238, 238)"){
            color = "rgb(255, 0, 0)";
          } else if(color == "rgb(255, 255, 0)" || color == "rgb(255, 174, 66)" || color == "rgb(238, 238, 130)"){
            color = "rgb(255, 255, 0)";
          }
          socket.emit("place", {column: number, color: color});
        }

        socket.on("username", function(name) {
          $("#error").text("");
          $("#error1").text("");
          $("#name").val(name);
          $("#name2").text(name+",");
          document.cookie = "name=" + name;
          cookieName = name;
        });

        socket.on("name taken", function (data) {
          msg = "The name " + data.new + " is taken. Your name is " + data.old;
          $("#error").text(msg);
          $("#name").val(data.old);
        });

        socket.on("no players", function () {
          $("#error1").text("no player in the lobby for match making.");
        });

        socket.on("no 2 players", function () {
          $("#error1").text("Must have 2 players in lobby for match making.");
        });

        socket.on("roomId", function (id) {
          $("#code").text(id);
        });

        socket.on("start game", function () { 
          $("#frontpage").hide();
          $("#frontheader").hide();
          $("#gamepage").show();
        });

        socket.on("win game", function (name) {
          $("#turn").text(name + " has won the Connect 4 game!");
          disableMove();
        });

        socket.on("tie game", function () {
          $("#turn").text("The connect 4 game ended in a draw.");
          disableMove();
        });

        socket.on("populateGameBoard", function (data) {
          for(i = 0; i < 6; i++){
            for(j = 0; j < 7; j++){
              if(data.array[i][j] == "rgb(255, 0, 0)"){

                if(document.cookie
                  .split(";")
                  .filter(item => item.trim().startsWith("color=")).length && 
                  document.cookie.replace(
                    /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
                    "$1"
                  ) == "Vibe"
                ){
                  $("#" + i + j).css("background", "rgb(13, 152, 186)");
                } else if(document.cookie
                  .split(";")
                  .filter(item => item.trim().startsWith("color=")).length &&
                  document.cookie.replace(
                    /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
                    "$1"
                  ) == "Rainbow"
                ){
                  $("#" + i + j).css("background", "rgb(130, 238, 238)");
                } else {
                  $("#" + i + j).css("background", "rgb(255, 0, 0)");
                }


              } else if(data.array[i][j] == "rgb(255, 255, 0)"){
                if (document.cookie
                  .split(";")
                  .filter(item => item.trim().startsWith("color=")).length &&
                  document.cookie.replace(
                    /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
                    "$1"
                  ) == "Vibe"
                ) {
                  $("#" + i + j).css("background", "rgb(255, 174, 66)");
                } else if (document.cookie
                  .split(";")
                  .filter(item => item.trim().startsWith("color=")).length &&
                  document.cookie.replace(
                    /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
                    "$1"
                  ) == "Rainbow"
                ) {
                  $("#" + i + j).css("background", "rgb(238, 238, 130)");
                } else {
                  $("#" + i + j).css("background", "rgb(255, 255, 0)");
                }

              }
            }
          }
        });

        socket.on("my turn", function (data) {
          if(data.color == "rgb(255, 0, 0)"){
            if (document.cookie
              .split(";")
              .filter(item => item.trim().startsWith("color=")).length &&
              document.cookie.replace(
                /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
                "$1"
              ) == "Vibe"
            ){
              placeColor = "rgb(13, 152, 186)";
            } else if(document.cookie
              .split(";")
              .filter(item => item.trim().startsWith("color=")).length &&
              document.cookie.replace(
                /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
                "$1"
              ) == "Rainbow"
            ){
              placeColor = "rgb(130, 238, 238)";
            } else {
              placeColor = "rgb(255, 0, 0)";
            }
          } else if(data.color == "rgb(255, 255, 0)"){
            if (document.cookie
              .split(";")
              .filter(item => item.trim().startsWith("color=")).length &&
              document.cookie.replace(
                /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
                "$1"
              ) == "Vibe"
            ) {
              placeColor = "rgb(255, 174, 66)";
            } else if (document.cookie
              .split(";")
              .filter(item => item.trim().startsWith("color=")).length &&
              document.cookie.replace(
                /(?:(?:^|.*;\s*)color\s*\=\s*([^;]*).*$)|^.*$/,
                "$1"
              ) == "Rainbow"
            ) {
              placeColor = "rgb(238, 238, 130)";
            } else {
              placeColor = "rgb(255, 255, 0)";
            }
          }

          $("#turn").text(data.name + ", it is your turn:");

          $(".grid-button").removeAttr('disabled');


          $(".grid-button").hover(function () {
            $(this).css("background", placeColor);
          }, function () {
            $(this).css("background", backgroundColor);
          });

          for(i = 0; i < 7; i++){
            var restriction = window.getComputedStyle(document.getElementById("5"+i), null).getPropertyValue("background-color");
            console.log(restriction);
            if(restriction != "rgb(255, 255, 255)"){
              $("#"+i).hover(function () {
                $(this).css("background", "gray");
              }, function () {
                $(this).css("background", backgroundColor);
              });
              $("#"+i).attr('disabled', 'disabled');
            }
          }
        });

        socket.on("wait for turn", function (firstname) {
          $("#turn").text("Please wait for "+ firstname +"'s turn.");
          disableMove();
        });

        function disableMove() {
          placeColor = "gray";
          $(".grid-button").attr('disabled', 'disabled');
          $(".grid-button").hover(function () {
            $(this).css("background", placeColor);
          }, function () {
            $(this).css("background", backgroundColor);
          });

        }

      });
    </script>
  </body>
</html>
